return require 'Q/UTILS/lua/code_gen' {

   declaration = [[

#include <limits.h>
#include <math.h>
#include "q_macros.h"
#include <stdio.h>
#include <stdint.h>
#include <time.h>
#include <sys/time.h>
#include <stdlib.h>
#include <stdbool.h>

typedef struct _rand_${out_qtype}_rec_type {
  uint64_t seed;
  ${out_ctype} lb;
  ${out_ctype} ub;
} RAND_${out_qtype}_REC_TYPE;

extern int
rand_${out_qtype}(
  ${out_ctype} *X,
  uint64_t nX,
  RAND_${out_qtype}_REC_TYPE *ptr_in,
  uint64_t idx
  );
   ]],

   definition = [[

#include "_rand_${out_qtype}.h"

static inline uint64_t RDTSC()
{
#ifdef RASPBERRY_PI
  struct timeval Tps; struct timezone Tpf;
  gettimeofday (&Tps, &Tpf);
  return ((uint64_t )Tps.tv_sec + 1000000* (uint64_t )Tps.tv_usec);
#else
  unsigned int hi, lo;
    __asm__ volatile("rdtsc" : "=a" (lo), "=d" (hi));
  return ((uint64_t)hi << 32) | lo;
#endif
}

//START_FUNC_DECL
int
rand_${out_qtype}(
  ${out_ctype} *X,
  uint64_t nX,
  RAND_${out_qtype}_REC_TYPE *ptr_in,
  uint64_t idx
  )
//STOP_FUNC_DECL
{
  int status = 0;

  uint64_t seed = ptr_in->seed;
  ${out_ctype} lb = ptr_in->lb;
  ${out_ctype} ub = ptr_in->ub;
  if ( idx == 0 ) { //seed has not yet been set
    if ( seed == 0 ) {
     seed = RDTSC();
    }
    srand48(seed);
  }
  ${out_ctype} range = ub - lb;
// TODO #pragma omp parallel for
  for ( uint64_t i = 0; i < nX; i++ ) { 
    ${gen_type} x = ${generator}();
    X[i] = (${out_ctype}) (lb + (${scaling_code}) );
  }
  return status;
}

   ]]
}
